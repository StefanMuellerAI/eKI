{
  "info": {
    "name": "eKI API v0.5 - Complete Security Analysis",
    "description": "KI-gestuetzte Sicherheitspruefung fuer Drehbuecher - Filmakademie Baden-Wuerttemberg\n\n**Features (M01-M05):**\n- FDX + PDF Drehbuch-Parsing\n- LLM-gestuetzte Risikoanalyse (Ollama/Mistral)\n- Risiko-Taxonomie mit 23 Klassen und Scoring\n- JSON + PDF Report-Erzeugung\n- One-Shot Report-Abholung (Pull) oder Push an ePro\n- Idempotenz und Job-Status-Tracking\n\n**Setup:**\n1. Start services: docker compose up -d\n2. Run migration: docker compose exec api alembic upgrade head\n3. Create API Key: docker compose exec api python scripts/create_api_key.py --insert\n4. Set API_KEY variable in Postman",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "eki-api",
    "version": "0.5.0"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{API_KEY}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "BASE_URL",
      "value": "http://localhost:8000",
      "type": "string"
    },
    {
      "key": "API_KEY",
      "value": "eki_your_api_key_here",
      "type": "string",
      "description": "Create with: docker compose exec api python scripts/create_api_key.py --insert"
    },
    {
      "key": "API_KEY_USER2",
      "value": "eki_second_user_key_here",
      "type": "string",
      "description": "Second API key (different user_id) for IDOR tests"
    },
    {
      "key": "JOB_ID",
      "value": "",
      "type": "string",
      "description": "Auto-set by async check request"
    },
    {
      "key": "REPORT_ID",
      "value": "",
      "type": "string",
      "description": "Auto-set from job status response"
    },
    {
      "key": "SCRIPT_B64",
      "value": "",
      "type": "string",
      "description": "Auto-set by pre-request scripts"
    }
  ],
  "item": [
    {
      "name": "1. Health & System",
      "item": [
        {
          "name": "Health Check",
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/health",
              "host": ["{{BASE_URL}}"],
              "path": ["health"]
            },
            "description": "Liveness probe\n\n**Expected:** 200 OK\n**Auth:** None"
          }
        },
        {
          "name": "Readiness Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/ready",
              "host": ["{{BASE_URL}}"],
              "path": ["ready"]
            },
            "description": "Readiness probe - checks DB, Redis, Temporal\n\n**Expected:** 200 OK with services status\n**Auth:** Bearer token"
          }
        },
        {
          "name": "Root Endpoint",
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/",
              "host": ["{{BASE_URL}}"],
              "path": [""]
            },
            "description": "API info and links to documentation"
          }
        },
        {
          "name": "Metrics (Prometheus)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/metrics",
              "host": ["{{BASE_URL}}"],
              "path": ["metrics"]
            },
            "description": "Prometheus metrics\n\n**Auth:** Bearer token"
          }
        }
      ],
      "description": "System health and monitoring endpoints"
    },
    {
      "name": "2. FDX Workflow (Async)",
      "item": [
        {
          "name": "Submit FDX Script (Async)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const resp = pm.response.json();",
                  "if (resp.job_id) {",
                  "    pm.collectionVariables.set('JOB_ID', resp.job_id);",
                  "    console.log('JOB_ID saved:', resp.job_id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "const fdx = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'+",
                  "'<FinalDraft DocumentType=\"Script\" Template=\"No\" Version=\"4\"><Content>'+",
                  "'<Paragraph Type=\"Scene Heading\" Number=\"1\"><Text>EXT. CLIFF EDGE - NIGHT</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>A stunt performer stands at the edge of a 15-meter cliff. Below, dark water churns. Safety divers are positioned in the water. The performer checks the harness one last time, then jumps.</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Character\"><Text>STUNT COORDINATOR</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Dialogue\"><Text>Clear the zone! Jump on my mark!</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Scene Heading\" Number=\"2\"><Text>EXT. HIGHWAY - DAY</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>Three cars race at high speed along the highway. The lead car swerves, narrowly avoiding a truck. Sparks fly as metal scrapes the guardrail. A massive explosion erupts behind them as a fuel tanker ignites.</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Character\"><Text>DRIVER</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Dialogue\"><Text>Hold on tight!</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Scene Heading\" Number=\"3\"><Text>INT. BURNING BUILDING - NIGHT</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>Flames engulf the hallway. Smoke makes visibility near zero. A firefighter carries an unconscious child through the inferno. The ceiling collapses behind them.</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Scene Heading\" Number=\"4\"><Text>EXT. ROOFTOP - DAY</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>Two fighters engage in hand-to-hand combat on the roof of a 20-story building. One performer is thrown near the edge. Weapons are drawn - prop knives and a replica firearm.</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Character\"><Text>HERO</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Dialogue\"><Text>This ends now.</Text></Paragraph>'+",
                  "'</Content></FinalDraft>';",
                  "const b64 = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(fdx));",
                  "pm.collectionVariables.set('SCRIPT_B64', b64);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"{{SCRIPT_B64}}\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"postman-fdx-test\",\n  \"delivery\": \"pull\",\n  \"idempotency_key\": \"postman-fdx-{{$timestamp}}\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check:async",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check:async"]
            },
            "description": "Submit a 4-scene FDX stunt script for async security analysis.\n\nScenes: cliff jump, highway chase with explosion, burning building, rooftop fight.\n\n**Expected:** 202 Accepted with job_id\n**Pipeline:** parse FDX -> risk analysis per scene (LLM) -> aggregate report (JSON+PDF) -> deliver\n**Next:** Poll job status until completed, then fetch report"
          }
        },
        {
          "name": "Poll Job Status",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const resp = pm.response.json();",
                  "if (resp.report_id) {",
                  "    pm.collectionVariables.set('REPORT_ID', resp.report_id);",
                  "    console.log('REPORT_ID saved:', resp.report_id);",
                  "}",
                  "console.log('Status:', resp.status, 'Progress:', resp.progress_percentage);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/jobs/{{JOB_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "jobs", "{{JOB_ID}}"]
            },
            "description": "Poll until status=completed and report_id is set.\n\n**Repeat** every 10-30 seconds until status is 'completed'.\n**Then:** Fetch the report using the report_id."
          }
        },
        {
          "name": "Fetch Report (One-Shot!)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/reports/{{REPORT_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "reports", "{{REPORT_ID}}"]
            },
            "description": "ONE-SHOT: Fetches JSON report + PDF (base64).\n\n**WARNING:** This URL is invalidated after the first successful call!\n**Response contains:**\n- report: Full JSON with findings, risk_summary, measures, scores\n- pdf_base64: Base64-encoded PDF report (Executive Summary + Findings + Checkliste)\n\n**Second call returns:** 410 Gone"
          }
        },
        {
          "name": "Verify One-Shot (Expect 410)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/reports/{{REPORT_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "reports", "{{REPORT_ID}}"]
            },
            "description": "Verify One-Shot enforcement.\n\n**Expected:** 410 Gone\n**Proves:** Report was deleted after first retrieval."
          }
        }
      ],
      "description": "Complete FDX workflow: Submit -> Poll -> Fetch Report -> Verify One-Shot\n\nUses the real LLM pipeline with taxonomy-based risk analysis."
    },
    {
      "name": "3. PDF Workflow (Async)",
      "item": [
        {
          "name": "Submit PDF Script (Multipart)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const resp = pm.response.json();",
                  "if (resp.job_id) {",
                  "    pm.collectionVariables.set('JOB_ID', resp.job_id);",
                  "    console.log('PDF JOB_ID saved:', resp.job_id);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": "",
                  "description": "Select a .pdf screenplay file"
                },
                {
                  "key": "project_id",
                  "value": "postman-pdf-test",
                  "type": "text"
                },
                {
                  "key": "script_format",
                  "value": "pdf",
                  "type": "text"
                },
                {
                  "key": "delivery",
                  "value": "pull",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check:async",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check:async"]
            },
            "description": "Submit a PDF screenplay via multipart file upload.\n\n**How to use:**\n1. Click 'Select Files' next to the 'file' field\n2. Choose a .pdf screenplay file\n3. Send the request\n\n**Pipeline:** extract text -> split at INT/EXT -> LLM structuring per scene -> risk analysis per scene -> aggregate report (JSON+PDF) -> deliver"
          }
        },
        {
          "name": "Poll PDF Job Status",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "const resp = pm.response.json();",
                  "if (resp.report_id) {",
                  "    pm.collectionVariables.set('REPORT_ID', resp.report_id);",
                  "    console.log('PDF REPORT_ID saved:', resp.report_id);",
                  "}",
                  "console.log('Status:', resp.status, 'Progress:', resp.progress_percentage);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/jobs/{{JOB_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "jobs", "{{JOB_ID}}"]
            },
            "description": "Poll until completed. PDF workflows take longer due to LLM structuring step."
          }
        },
        {
          "name": "Fetch PDF Report (One-Shot!)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/reports/{{REPORT_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "reports", "{{REPORT_ID}}"]
            },
            "description": "ONE-SHOT: JSON report + PDF. Same as FDX report endpoint.\n\n**WARNING:** URL is invalidated after first retrieval!"
          }
        }
      ],
      "description": "Complete PDF workflow: Upload file -> Poll -> Fetch Report\n\nPDF pipeline includes LLM-based scene structuring before risk analysis."
    },
    {
      "name": "4. Sync Check (Stub)",
      "item": [
        {
          "name": "Sync FDX Check (JSON)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "const fdx = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'+",
                  "'<FinalDraft DocumentType=\"Script\"><Content>'+",
                  "'<Paragraph Type=\"Scene Heading\" Number=\"1\"><Text>INT. OFFICE - DAY</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>A woman reviews documents at her desk.</Text></Paragraph>'+",
                  "'</Content></FinalDraft>';",
                  "const b64 = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(fdx));",
                  "pm.collectionVariables.set('SCRIPT_B64', b64);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"{{SCRIPT_B64}}\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"postman-sync-test\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "Quick synchronous check.\n\n**Note:** Returns a stub report (M01). For real LLM-based analysis, use the async endpoint."
          }
        },
        {
          "name": "Sync PDF Check (Multipart)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "formdata",
              "formdata": [
                {
                  "key": "file",
                  "type": "file",
                  "src": "",
                  "description": "Select a .pdf file"
                },
                {
                  "key": "project_id",
                  "value": "postman-sync-pdf",
                  "type": "text"
                }
              ]
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "Synchronous PDF check via file upload.\n\n**Note:** Returns a stub report (M01). For real analysis, use the async endpoint."
          }
        }
      ],
      "description": "Quick synchronous checks (stub responses).\n\nFor real LLM-based risk analysis, use the async workflows in sections 2 and 3."
    },
    {
      "name": "5. Security Tests",
      "item": [
        {
          "name": "Test: Missing Auth (401)",
          "request": {
            "auth": { "type": "noauth" },
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"dGVzdA==\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"test123\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 401 Unauthorized\n\nRequest without Authorization header."
          }
        },
        {
          "name": "Test: Invalid API Key (401)",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "eki_invalid_key_here", "type": "string" }]
            },
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"dGVzdA==\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"test123\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 401 Unauthorized\n\nRequest with invalid/unknown API key."
          }
        },
        {
          "name": "Test: Invalid Base64 (422)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"this-is-not-valid-base64!!!\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"test123\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 422 Validation Error\n\nInvalid base64 in script_content."
          }
        },
        {
          "name": "Test: SQL Injection (422)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"dGVzdA==\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"'; DROP TABLE users; --\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 422 Validation Error\n\nSQL injection attempt in project_id (only alphanumeric + hyphens allowed)."
          }
        },
        {
          "name": "Test: SSRF Private IP (422)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"dGVzdA==\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"test123\",\n  \"callback_url\": \"http://192.168.1.1/admin\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 422 Validation Error\n\nCallback URL with private IP blocked (SSRF prevention)."
          }
        },
        {
          "name": "Test: SSRF Non-Whitelisted Domain (422)",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"dGVzdA==\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"test123\",\n  \"callback_url\": \"https://evil-domain.com/steal-data\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check"]
            },
            "description": "**Expected:** 422 Validation Error\n\nOnly whitelisted domains allowed for callback_url (epro.filmakademie.de, epro-stage.filmakademie.de)."
          }
        },
        {
          "name": "Test: IDOR - Other User's Job (404)",
          "request": {
            "auth": {
              "type": "bearer",
              "bearer": [{ "key": "token", "value": "{{API_KEY_USER2}}", "type": "string" }]
            },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/v1/security/jobs/{{JOB_ID}}",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "jobs", "{{JOB_ID}}"]
            },
            "description": "**Expected:** 404 Not Found\n\n**Setup:** Requires API_KEY_USER2 variable (different user_id than API_KEY).\nAccessing another user's job via a different API key should return 404 (ownership check)."
          }
        },
        {
          "name": "Test: Idempotency (Same Key)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "const fdx = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'+",
                  "'<FinalDraft DocumentType=\"Script\"><Content>'+",
                  "'<Paragraph Type=\"Scene Heading\"><Text>INT. TEST - DAY</Text></Paragraph>'+",
                  "'<Paragraph Type=\"Action\"><Text>A simple test scene.</Text></Paragraph>'+",
                  "'</Content></FinalDraft>';",
                  "const b64 = CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(fdx));",
                  "pm.collectionVariables.set('SCRIPT_B64', b64);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"script_content\": \"{{SCRIPT_B64}}\",\n  \"script_format\": \"fdx\",\n  \"project_id\": \"idem-test\",\n  \"idempotency_key\": \"same-key-twice\"\n}",
              "options": { "raw": { "language": "json" } }
            },
            "url": {
              "raw": "{{BASE_URL}}/v1/security/check:async",
              "host": ["{{BASE_URL}}"],
              "path": ["v1", "security", "check:async"]
            },
            "description": "Send twice with same idempotency_key.\n\n**Expected:** Second call returns same job_id (no duplicate workflow created)."
          }
        }
      ],
      "description": "Security and validation tests.\n\nRun all requests - each should return the expected error code."
    },
    {
      "name": "6. Documentation",
      "item": [
        {
          "name": "Swagger UI (Dev only)",
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/docs",
              "host": ["{{BASE_URL}}"],
              "path": ["docs"]
            },
            "description": "Interactive API docs.\n\n**Dev:** 200 OK\n**Production (DEBUG=false):** 404 Not Found"
          }
        },
        {
          "name": "OpenAPI Spec",
          "request": {
            "auth": { "type": "noauth" },
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{BASE_URL}}/openapi.json",
              "host": ["{{BASE_URL}}"],
              "path": ["openapi.json"]
            },
            "description": "Machine-readable OpenAPI 3.1 specification"
          }
        }
      ],
      "description": "API documentation endpoints"
    }
  ]
}
